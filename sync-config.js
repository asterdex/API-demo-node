#!/usr/bin/env node

/**
 * Configuration Sync Script / é…ç½®åŒæ­¥è„šæœ¬
 * 
 * This script syncs the shared-config.js to all demo directories
 * æ­¤è„šæœ¬å°†shared-config.jsåŒæ­¥åˆ°æ‰€æœ‰ç¤ºä¾‹ç›®å½•
 * 
 * Usage / ä½¿ç”¨æ–¹æ³•:
 * $ node sync-config.js
 */

const fs = require('fs');
const path = require('path');

// Color codes for terminal output / ç»ˆç«¯è¾“å‡ºé¢œè‰²ä»£ç 
const colors = {
    reset: '\x1b[0m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    red: '\x1b[31m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
};

/**
 * Print colored message / æ‰“å°å½©è‰²æ¶ˆæ¯
 */
function print(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

/**
 * Read shared configuration / è¯»å–å…±äº«é…ç½®
 */
function readSharedConfig() {
    const configPath = path.join(__dirname, 'shared-config.js');
    
    if (!fs.existsSync(configPath)) {
        print('âŒ Error: shared-config.js not found!', 'red');
        print('   Please create shared-config.js first.', 'red');
        print('   è¯·å…ˆåˆ›å»º shared-config.js æ–‡ä»¶ã€‚', 'red');
        process.exit(1);
    }
    
    try {
        const config = require(configPath);
        return config;
    } catch (error) {
        print(`âŒ Error reading shared-config.js: ${error.message}`, 'red');
        process.exit(1);
    }
}

/**
 * Generate config content for a specific directory / ä¸ºç‰¹å®šç›®å½•ç”Ÿæˆé…ç½®å†…å®¹
 */
function generateConfigContent(sharedConfig, type) {
    const configs = {
        spot: {
            baseUrl: sharedConfig.SPOT_BASE_URL || 'https://sapi.asterdex.com',
            needsWallet: true,
            symbol: sharedConfig.DEFAULT_SYMBOL || 'BNBUSDT',
        },
        futures: {
            baseUrl: sharedConfig.FUTURES_BASE_URL || 'https://fapi.asterdex.com',
            needsWallet: false,
            symbol: sharedConfig.DEFAULT_SYMBOL || 'BTCUSDT',
        },
        'futures-v3': {
            baseUrl: sharedConfig.FUTURES_BASE_URL || 'https://fapi.asterdex.com',
            needsWallet: false,
            symbol: sharedConfig.DEFAULT_SYMBOL || 'BTCUSDT',
        },
    };
    
    const typeConfig = configs[type];
    
    let content = `/**
 * API Configuration / APIé…ç½®
 * 
 * âš ï¸ This file is auto-generated by sync-config.js
 * âš ï¸ æ­¤æ–‡ä»¶ç”± sync-config.js è‡ªåŠ¨ç”Ÿæˆ
 * 
 * To update, edit shared-config.js and run: node sync-config.js
 * è¦æ›´æ–°ï¼Œè¯·ç¼–è¾‘ shared-config.js å¹¶è¿è¡Œï¼šnode sync-config.js
 */

module.exports = {
    // Base URL / åŸºç¡€URL
    BASE_URL: '${typeConfig.baseUrl}',
    
    // API Key / APIå¯†é’¥
    API_KEY: '${sharedConfig.API_KEY}',
    
    // Secret Key / å¯†é’¥
    SECRET_KEY: '${sharedConfig.SECRET_KEY}',
    `;
    
    if (typeConfig.needsWallet) {
        content += `
    // Wallet Private Key (for wallet signature endpoints) / é’±åŒ…ç§é’¥ï¼ˆç”¨äºé’±åŒ…ç­¾åæ¥å£ï¼‰
    PRIVATE_KEY: '${sharedConfig.PRIVATE_KEY}',
    
    // Wallet Address / é’±åŒ…åœ°å€
    WALLET_ADDRESS: '${sharedConfig.WALLET_ADDRESS}',
    `;
    }
    
    content += `
    // Default trading pair / é»˜è®¤äº¤æ˜“å¯¹
    DEFAULT_SYMBOL: '${typeConfig.symbol}',
    
    // Receive window (milliseconds) / æ¥æ”¶çª—å£ï¼ˆæ¯«ç§’ï¼‰
    RECV_WINDOW: ${sharedConfig.RECV_WINDOW || 5000}
};
`;
    
    return content;
}

/**
 * Sync configuration to a directory / åŒæ­¥é…ç½®åˆ°ç›®å½•
 */
function syncToDirectory(sharedConfig, directory, type) {
    const configPath = path.join(__dirname, directory, 'config.js');
    const content = generateConfigContent(sharedConfig, type);
    
    try {
        fs.writeFileSync(configPath, content, 'utf8');
        print(`  âœ“ Synced to ${directory}/config.js`, 'green');
        return true;
    } catch (error) {
        print(`  âœ— Failed to sync to ${directory}/config.js: ${error.message}`, 'red');
        return false;
    }
}

/**
 * Validate configuration / éªŒè¯é…ç½®
 */
function validateConfig(config) {
    const warnings = [];
    const errors = [];
    
    // Check required fields / æ£€æŸ¥å¿…éœ€å­—æ®µ
    if (!config.API_KEY || config.API_KEY === 'your_api_key_here') {
        warnings.push('API_KEY is not configured / API_KEYæœªé…ç½®');
    }
    
    if (!config.SECRET_KEY || config.SECRET_KEY === 'your_secret_key_here') {
        warnings.push('SECRET_KEY is not configured / SECRET_KEYæœªé…ç½®');
    }
    
    // Check wallet config / æ£€æŸ¥é’±åŒ…é…ç½®
    if (config.PRIVATE_KEY && config.PRIVATE_KEY !== '0x0000000000000000000000000000000000000000000000000000000000000000') {
        if (!config.PRIVATE_KEY.match(/^0x[a-fA-F0-9]{64}$/)) {
            errors.push('PRIVATE_KEY format invalid (should be 0x + 64 hex chars) / PRIVATE_KEYæ ¼å¼æ— æ•ˆ');
        }
    }
    
    if (config.WALLET_ADDRESS && config.WALLET_ADDRESS !== '0x0000000000000000000000000000000000000000') {
        if (!config.WALLET_ADDRESS.match(/^0x[a-fA-F0-9]{40}$/)) {
            errors.push('WALLET_ADDRESS format invalid (should be 0x + 40 hex chars) / WALLET_ADDRESSæ ¼å¼æ— æ•ˆ');
        }
    }
    
    return { warnings, errors };
}

/**
 * Main function / ä¸»å‡½æ•°
 */
function main() {
    print('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'cyan');
    print('  Configuration Sync / é…ç½®åŒæ­¥', 'cyan');
    print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n', 'cyan');
    
    // Read shared config / è¯»å–å…±äº«é…ç½®
    print('Reading shared-config.js... / è¯»å–å…±äº«é…ç½®ä¸­...', 'blue');
    const sharedConfig = readSharedConfig();
    print('âœ“ Shared configuration loaded / å…±äº«é…ç½®å·²åŠ è½½\n', 'green');
    
    // Validate config / éªŒè¯é…ç½®
    print('Validating configuration... / éªŒè¯é…ç½®ä¸­...', 'blue');
    const { warnings, errors } = validateConfig(sharedConfig);
    
    if (errors.length > 0) {
        print('\nâŒ Configuration Errors / é…ç½®é”™è¯¯:', 'red');
        errors.forEach(err => print(`  â€¢ ${err}`, 'red'));
        print('\nPlease fix errors in shared-config.js / è¯·ä¿®å¤ shared-config.js ä¸­çš„é”™è¯¯\n', 'red');
        process.exit(1);
    }
    
    if (warnings.length > 0) {
        print('\nâš ï¸  Configuration Warnings / é…ç½®è­¦å‘Š:', 'yellow');
        warnings.forEach(warn => print(`  â€¢ ${warn}`, 'yellow'));
        print('');
    } else {
        print('âœ“ Configuration looks good / é…ç½®çœ‹èµ·æ¥ä¸é”™\n', 'green');
    }
    
    // Sync to all directories / åŒæ­¥åˆ°æ‰€æœ‰ç›®å½•
    print('Syncing to all directories... / åŒæ­¥åˆ°æ‰€æœ‰ç›®å½•ä¸­...', 'blue');
    
    const directories = [
        { dir: 'spot-demo', type: 'spot' },
        { dir: 'futures-demo', type: 'futures' },
        { dir: 'futures-v3-demo', type: 'futures-v3' },
    ];
    
    let successCount = 0;
    directories.forEach(({ dir, type }) => {
        if (syncToDirectory(sharedConfig, dir, type)) {
            successCount++;
        }
    });
    
    // Summary / æ€»ç»“
    print('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'cyan');
    if (successCount === directories.length) {
        print('âœ“ All configurations synced successfully!', 'green');
        print('âœ“ æ‰€æœ‰é…ç½®å·²æˆåŠŸåŒæ­¥ï¼', 'green');
        print('\nğŸ‰ Now you can use all API examples!', 'green');
        print('ğŸ‰ ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰APIç¤ºä¾‹äº†ï¼', 'green');
    } else {
        print(`âš ï¸  ${successCount}/${directories.length} configurations synced`, 'yellow');
        print(`âš ï¸  ${successCount}/${directories.length} ä¸ªé…ç½®å·²åŒæ­¥`, 'yellow');
    }
    print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n', 'cyan');
    
    // Next steps / ä¸‹ä¸€æ­¥
    if (warnings.length > 0) {
        print('ğŸ“ Next steps / ä¸‹ä¸€æ­¥:', 'blue');
        print('  1. Edit shared-config.js to fill in your credentials', 'blue');
        print('     ç¼–è¾‘ shared-config.js å¡«å†™æ‚¨çš„å‡­è¯', 'blue');
        print('  2. Run this script again: node sync-config.js', 'blue');
        print('     å†æ¬¡è¿è¡Œæ­¤è„šæœ¬ï¼šnode sync-config.js', 'blue');
        print('  3. Test with: cd spot-demo && node 01_ping.js', 'blue');
        print('     æµ‹è¯•ï¼šcd spot-demo && node 01_ping.js\n', 'blue');
    } else {
        print('ğŸš€ Ready to use! Try running:', 'green');
        print('  cd spot-demo && node 01_ping.js', 'green');
        print('  cd futures-demo && node 01_ping.js\n', 'green');
    }
}

// Run main function / è¿è¡Œä¸»å‡½æ•°
try {
    main();
} catch (error) {
    print(`\nâŒ Unexpected error / æ„å¤–é”™è¯¯: ${error.message}`, 'red');
    print(error.stack, 'red');
    process.exit(1);
}

